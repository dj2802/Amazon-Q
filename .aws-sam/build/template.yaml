AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Invoice Approval Workflow
Globals:
  Function:
    Runtime: python3.11
    Timeout: 30
    MemorySize: 128
Resources:
  ValidateInvoiceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: validate-invoice
      CodeUri: ValidateInvoiceFunction
      Handler: validate_invoice.lambda_handler
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
    Metadata:
      SamResourceId: ValidateInvoiceFunction
  ApproveInvoiceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: approve-invoice
      CodeUri: ApproveInvoiceFunction
      Handler: approve_invoice.lambda_handler
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
    Metadata:
      SamResourceId: ApproveInvoiceFunction
  RejectInvoiceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: reject-invoice
      CodeUri: RejectInvoiceFunction
      Handler: reject_invoice.lambda_handler
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
    Metadata:
      SamResourceId: RejectInvoiceFunction
  SendNotificationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: send-notification
      CodeUri: SendNotificationFunction
      Handler: send_notification.lambda_handler
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
    Metadata:
      SamResourceId: SendNotificationFunction
  InvoiceWorkflowStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: InvoiceApprovalWorkflow
      DefinitionUri: ..\..\src\stepfunctions\invoice-workflow.json
      DefinitionSubstitutions:
        ValidateInvoiceFunctionArn:
          Fn::GetAtt:
          - ValidateInvoiceFunction
          - Arn
        ApproveInvoiceFunctionArn:
          Fn::GetAtt:
          - ApproveInvoiceFunction
          - Arn
        RejectInvoiceFunctionArn:
          Fn::GetAtt:
          - RejectInvoiceFunction
          - Arn
        SendNotificationFunctionArn:
          Fn::GetAtt:
          - SendNotificationFunction
          - Arn
      Role:
        Fn::GetAtt:
        - StepFunctionsExecutionRole
        - Arn
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
  StepFunctionsExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: states.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: InvokeLambdaPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action: lambda:InvokeFunction
            Resource:
            - Fn::GetAtt:
              - ValidateInvoiceFunction
              - Arn
            - Fn::GetAtt:
              - ApproveInvoiceFunction
              - Arn
            - Fn::GetAtt:
              - RejectInvoiceFunction
              - Arn
            - Fn::GetAtt:
              - SendNotificationFunction
              - Arn
Outputs:
  StateMachineArn:
    Description: Invoice Workflow State Machine ARN
    Value:
      Ref: InvoiceWorkflowStateMachine
  ValidateInvoiceFunctionArn:
    Description: Validate Invoice Function ARN
    Value:
      Fn::GetAtt:
      - ValidateInvoiceFunction
      - Arn
